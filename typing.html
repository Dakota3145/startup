<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/1184/1184161.png"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="index.css" />

    <title>The Typing Game</title>
  </head>
  <body>
    <header>
      <img
        src="https://img.uxwing.com/wp-content/themes/uxwing/download/web-app-development/typing-icon.svg"
        width="100"
      />
      <h1>The Typing Game</h1>
      <h2>Dakota Stevens</h2>
    </header>
    <main>
      <div class="wrapper">
        <div class="logout">
          <a class="btn btn-primary" href="/" role="button">Dave - Logout</a>
        </div>
        <div class="leaderboard">
          <p>Leaderboard</p>
          <ol id="leaderboard"></ol>
        </div>
        <form id="myform" class="level" onSubmit="return finishTimer()">
          <p id="levelNum">Level: 9 WPM</p>
          <p id="levelText">He is nice</p>
          <p id="demo"></p>
          <input type="text" id="typeInput" placeholder="Type Here" value=""/>
          <button type="submit" class="btn btn-primary">Check Input</button>
        </form>
        <div class="notifications">
          <p>Notifications</p>
          <ul>
            <li>Sarah just got 9 WPM!</li>
            <li id="notification">Jeremy just got 9 WPM!</li>
          </ul>
        </div>
      </div>
    </main>
    <footer>
      <a class="btn btn-primary" href="https://github.com/Dakota3145/startup" role="button">Check out the Source Code Here</a>
    </footer>
    <script>

      let leaderboardNames = [];
      let leaderboardLevels = [];
      let mockNewDatabaseData = false;
      let loadPageTime = new Date().getTime();
      let updateSeconds = 10;
      let mockNewDataDate = new Date(loadPageTime + updateSeconds*1000);
      let didPass = false;
      let levels = {
        9: "He is nice",
        12: "You can sit here",
        15: "She went up the hill",
        21: "You can do it in a week",
        24: "I want to go see a fun movie",
        27: "Do you want to go to a ball game",
        30: "It is a lot of fun to drive a car",
        33: "Do you want to go and get a bite to eat",
        36: "Can you get that to me by the end of the day",
        39: "I can pick you up from your work if you want me to"
      }

      let currLevel = 9;

      function showModal(event = null) {
        if (event != null) {
          event.preventDefault();
        }
        const inputVal = document.querySelector('#typeInput').value;
        let modalEl = document.querySelector('#myModal');
        let modalText = document.querySelector('#modalText');
        if (inputVal != null && inputVal == levels[currLevel]) {
          didPass = true;
          modalText.innerText = "Passed! Your input matched the given text. Click close to start the next level";
        }
        else {
          didPass = false;
          modalText.innerText = "Missed! Your input didn't match the given text. Click close to start over";
        }
        const msgModal = new bootstrap.Modal(modalEl, {});
        msgModal.show();
      }

      let shouldShowModal = false;

      function finishTimer(event = null) {
        if (event != null) {
          event.preventDefault();
        }
        shouldShowModal = true;
        return false;
      }

      function removeAllChildNodes(parent) {
        while (parent.firstChild) {
          parent.removeChild(parent.firstChild);
        }
      }

      function removeLeaderboard() {
        let leaderboardList = document.getElementById("leaderboard");
        removeAllChildNodes(leaderboardList)
      }
      
      function populateLeaderboard() {
        console.log("got to populateLeaderboard");
        console.log("leaderboard names: ", leaderboardNames);
        console.log("leaderBoard levels: ", leaderboardLevels);
        let list = document.getElementById("leaderboard");
        let leaderboardText = "";
        for (i = 0; i < leaderboardNames.length; ++i) {
          let li = document.createElement('li');
          leaderboardText = `${leaderboardNames[i]}: ${leaderboardLevels[i]} WPM`;
          li.innerText = leaderboardText;
          list.appendChild(li);
        }
      }

      function getLeaderboardFromDatabase() {
        //This is where I will grab data from database, this is just pretending to grab that data
        console.log("Got to getLeaderboardFromDatabase");
        databaseNames = [];
        databaseLevels = [];
        if (mockNewDatabaseData) {
          databaseNames = ["Henry", "Sam", "Josh", "Sarah", "Jeremy"];
          databaseLevels = [12, 12, 12, 9, 9];
        }
        else {
          databaseNames = ["Henry", "Sam", "Josh", "Sarah"];
          databaseLevels = [12, 12, 12, 9];
        }
        //only remove and update leaderboard html if it's changed
        if (JSON.stringify(databaseNames) !== JSON.stringify(leaderboardNames) || 
            JSON.stringify(databaseLevels) !== JSON.stringify(leaderboardLevels)) {
          leaderboardNames = databaseNames;
          leaderboardLevels = databaseLevels;
          removeLeaderboard();
          populateLeaderboard();
        }
      }

      getLeaderboardFromDatabase();

      function setTimer() {
        // Set the date we're counting down to
        let curr = new Date().getTime();
        numSeconds = 22;
        let countDownDate = new Date(curr + numSeconds*1000);

        // Update the count down every 1 second
        let x = setInterval(function() {
          let now = new Date().getTime();
          let distance = countDownDate - now;
          let seconds = Math.floor((distance % (1000 * 60)) / 1000);
          document.getElementById("demo").innerHTML = seconds + "s";
          if (mockNewDataDate < now) {
            mockNewDatabaseData = true;
          }
          //update database every 5 seconds
          if (Math.floor((now % (1000 * 60)) / 1000) % 5 == 0) {
            getLeaderboardFromDatabase();
          }
          if (distance < 0) {
            shouldShowModal = true;
          }
          if (shouldShowModal == true) {
            shouldShowModal = false;
            clearInterval(x);
            document.getElementById("demo").innerHTML = "EXPIRED";
            showModal();
          }

        }, 1000);
      }

      function changeLevel() {
        //TODO: change html inner text of the typing level
        document.getElementById("typeInput").value = "";
        if (didPass) {
          if (currLevel < 39) {
            currLevel += 3;
          }
        }
        else {
          currLevel = 9;
        }
        let levelNum = document.querySelector('#levelNum');
        levelNum.innerText = `Level: ${currLevel} WPM`;
        let levelText = document.querySelector('#levelText');
        levelText.innerText = levels[currLevel];
        setTimer();
      }

      function replaceLeaderboard() {
        let list = document.getElementById("leaderboard");
        let li = document.createElement('li');
        li.innerText = "Jeremy: 9 WPM";
        list.appendChild(li);
      }

      setTimer();

    </script>

    <!-- modal passed dialog -->
    <div class="modal fade" id="myModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-dark">
          <div class="modal-body" id="modalText">Passed! Your input matched the given text. Click close to start the next level</div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onClick="changeLevel()">Close</button>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
